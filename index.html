<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Costco Shopping List</title>
    
    <!-- Chart.js library for price trend visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK Scripts -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, setDoc, runTransaction, getDocs, writeBatch, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDuD1njiJ0zfRMWgCuQEvldCNNiN6ZcPx0",
          authDomain: "costco-list-data.firebaseapp.com",
          projectId: "costco-list-data",
          storageBucket: "costco-list-data.appspot.com",
          messagingSenderId: "461334182204",
          appId: "1:461334182204:web:9a0849745d1b_c639",
          measurementId: "G-REJQK4B1G3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- App Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const itemInput = document.getElementById('item-input');
            const priceInput = document.getElementById('price-input');
            const quantityInput = document.getElementById('quantity-input');
            const addBtn = document.getElementById('add-btn');
            const shoppingListEl = document.getElementById('shopping-list');
            const totalCostEl = document.getElementById('total-cost');
            const historyListEl = document.getElementById('history-list');
            const tabNav = document.querySelector('.tab-nav');
            const sortBar = document.querySelector('.sort-bar');
            const loadingIndicator = document.getElementById('loading');
            const appContent = document.getElementById('app-content');
            const suggestionsContainer = document.getElementById('suggestions-container');
            const clearListBtn = document.getElementById('clear-list-btn');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmClearBtn = document.getElementById('confirm-clear-btn');
            const cancelClearBtn = document.getElementById('cancel-clear-btn');
            const chartContainer = document.getElementById('chart-container');
            const priceChartCanvas = document.getElementById('price-chart');
            const renameModal = document.getElementById('rename-modal');
            const renameOldNameEl = document.getElementById('rename-old-name');
            const renameNewNameInput = document.getElementById('rename-new-name-input');
            const confirmRenameBtn = document.getElementById('confirm-rename-btn');
            const cancelRenameBtn = document.getElementById('cancel-rename-btn');
            const locationSelect = document.getElementById('location-select');
            const addLocationBtn = document.getElementById('add-location-btn');
            const addLocationModal = document.getElementById('add-location-modal');
            const newLocationNameInput = document.getElementById('new-location-name-input');
            const confirmAddLocationBtn = document.getElementById('confirm-add-location-btn');
            const cancelAddLocationBtn = document.getElementById('cancel-add-location-btn');

            // --- App State ---
            let shoppingList = [];
            let priceHistory = {};
            let currentSort = 'added';
            let isAuthenticated = false;
            let priceChart = null;
            let itemToRename = null;
            let currentLocation = null;
            let listeners = [];

            // --- Helper Function ---
            const toTitleCase = (str) => {
                if (!str) return "";
                return str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
            };

            // --- Authentication ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    isAuthenticated = true;
                    loadingIndicator.style.display = 'none';
                    appContent.style.display = 'block';
                    loadLocations();
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Anonymous sign-in failed:", error);
                        loadingIndicator.textContent = 'Error connecting. Please check your Firebase setup.';
                    });
                }
            });

            // --- Location Management ---
            const loadLocations = async () => {
                const locationsQuery = query(collection(db, 'locations'));
                onSnapshot(locationsQuery, (snapshot) => {
                    const locations = snapshot.docs.map(doc => doc.id).sort();
                    locationSelect.innerHTML = '';
                    locations.forEach(loc => {
                        const option = document.createElement('option');
                        option.value = loc;
                        option.textContent = loc;
                        locationSelect.appendChild(option);
                    });

                    const lastLocation = localStorage.getItem('costco-list-location');
                    if (lastLocation && locations.includes(lastLocation)) {
                        locationSelect.value = lastLocation;
                    }
                    
                    if (locations.length > 0) {
                        setCurrentLocation(locationSelect.value);
                    }
                });
            };

            const setCurrentLocation = (locationName) => {
                if (currentLocation === locationName) return;
                currentLocation = locationName;
                localStorage.setItem('costco-list-location', locationName);
                setupRealtimeListeners();
            };

            // --- Real-time Data Listeners ---
            function setupRealtimeListeners() {
                listeners.forEach(unsubscribe => unsubscribe());
                listeners = [];

                if (!isAuthenticated || !currentLocation) return;

                const listQuery = query(collection(db, 'locations', currentLocation, 'list'));
                const listUnsubscribe = onSnapshot(listQuery, (snapshot) => {
                    shoppingList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderList();
                });

                const historyQuery = query(collection(db, 'locations', currentLocation, 'priceHistory'));
                const historyUnsubscribe = onSnapshot(historyQuery, (snapshot) => {
                    priceHistory = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data && data.entries) {
                            priceHistory[doc.id] = data.entries;
                        }
                    });
                    renderHistory();
                });
                
                listeners.push(listUnsubscribe, historyUnsubscribe);
            }

            // --- Firestore Data Functions ---
            const addItem = async () => {
                const rawItemName = itemInput.value.trim();
                if (!rawItemName || !isAuthenticated || !currentLocation) return;
                const itemName = toTitleCase(rawItemName);
                const itemPrice = parseFloat(priceInput.value) || 0;
                const itemQuantity = parseInt(quantityInput.value, 10) || 1;

                try {
                    await addDoc(collection(db, 'locations', currentLocation, 'list'), {
                        dateAdded: Date.now(),
                        name: itemName,
                        price: itemPrice,
                        quantity: itemQuantity,
                        checked: false
                    });
                    updatePriceHistory(itemName, itemPrice);
                    itemInput.value = '';
                    priceInput.value = '';
                    quantityInput.value = '1';
                    suggestionsContainer.innerHTML = '';
                    itemInput.focus();
                } catch (error) {
                    console.error("Error adding item: ", error);
                }
            };
            
            const updateItem = async (itemId, updatedData) => {
                if (!isAuthenticated || !currentLocation) return;
                const itemRef = doc(db, 'locations', currentLocation, 'list', itemId);
                await updateDoc(itemRef, updatedData);
            };

            const deleteItem = async (itemId) => {
                if (!isAuthenticated || !currentLocation) return;
                await deleteDoc(doc(db, 'locations', currentLocation, 'list', itemId));
            };

            const clearList = async () => {
                if (!isAuthenticated || !currentLocation) return;
                const listCollection = collection(db, 'locations', currentLocation, 'list');
                const listSnapshot = await getDocs(listCollection);
                const deletePromises = listSnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                confirmationModal.classList.add('hidden');
            };

            const updatePriceHistory = async (itemName, newPrice) => {
                if (newPrice <= 0 || !isAuthenticated || !currentLocation) return;
                const historyRef = doc(db, 'locations', currentLocation, 'priceHistory', itemName);
                try {
                    await runTransaction(db, async (transaction) => {
                        const historyDoc = await transaction.get(historyRef);
                        const currentHistory = historyDoc.exists() ? historyDoc.data().entries : [];
                        const today = new Date().toISOString().split('T')[0];
                        const newEntry = { price: newPrice, date: today };
                        if (currentHistory.length > 0 && currentHistory[0].date === today && currentHistory[0].price === newPrice) return;
                        const updatedHistory = [newEntry, ...currentHistory].slice(0, 10);
                        transaction.set(historyRef, { entries: updatedHistory }, { merge: true });
                    });
                } catch (e) {
                    console.error("Price history transaction failed: ", e);
                }
            };
            
            const editPriceHistoryEntry = async (itemName, date, newPrice) => {
                if (newPrice < 0 || !isAuthenticated || !currentLocation) return;
                const historyRef = doc(db, 'locations', currentLocation, 'priceHistory', itemName);
                try {
                    await runTransaction(db, async (transaction) => {
                        const historyDoc = await transaction.get(historyRef);
                        if (!historyDoc.exists()) return;
                        const currentHistory = historyDoc.data().entries;
                        const entryIndex = currentHistory.findIndex(entry => entry.date === date);
                        if (entryIndex > -1) {
                            currentHistory[entryIndex].price = newPrice;
                            transaction.set(historyRef, { entries: currentHistory });
                        }
                    });
                } catch (e) {
                    console.error("Price history edit transaction failed: ", e);
                }
            };

            const renameItemInDb = async (oldName, newName) => {
                if (!oldName || !newName || oldName === newName || !isAuthenticated || !currentLocation) return;
                
                const oldHistoryRef = doc(db, 'locations', currentLocation, 'priceHistory', oldName);
                const newHistoryRef = doc(db, 'locations', currentLocation, 'priceHistory', newName);
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const oldDoc = await transaction.get(oldHistoryRef);
                        if (oldDoc.exists()) {
                            transaction.set(newHistoryRef, oldDoc.data());
                            transaction.delete(oldHistoryRef);
                        }
                    });
                } catch (e) {
                    console.error("Error renaming price history:", e);
                    return;
                }

                const listQuery = query(collection(db, 'locations', currentLocation, 'list'), where("name", "==", oldName));
                const listSnapshot = await getDocs(listQuery);
                const batch = writeBatch(db);
                listSnapshot.forEach(doc => {
                    batch.update(doc.ref, { name: newName });
                });
                await batch.commit();
            };
            
            // --- Rendering Functions ---
            const getCategory = (itemName) => {
                const name = itemName.toLowerCase();
                if (['apple', 'avocado', 'banana', 'berries', 'blueberries', 'broccoli', 'cabbage', 'carrots', 'celery', 'cherries', 'cucumber', 'dates', 'garlic', 'grapes', 'lemon', 'lettuce', 'mango', 'mushrooms', 'onions', 'orange', 'peaches', 'pepper', 'pineapple', 'potatoes', 'raspberries', 'salad', 'spinach', 'sprouts', 'strawberries', 'tomatoes', 'watermelon', 'zucchini'].some(k => name.includes(k))) return 'Produce';
                if (['bacon', 'beef', 'brats', 'chicken', 'fish', 'ground beef', 'ham', 'lamb', 'meatballs', 'pork', 'ribs', 'salami', 'salmon', 'sausage', 'shrimp', 'steak', 'tuna'].some(k => name.includes(k))) return 'Meat & Seafood';
                if (['bagel', 'bread', 'brioche', 'buns', 'cake', 'croissant', 'english muffins', 'muffins', 'pie', 'rolls'].some(k => name.includes(k))) return 'Bakery';
                if (['butter', 'cheese', 'cottage cheese', 'cream cheese', 'creamer', 'dubliner', 'eggs', 'half n half', 'heavy cream', 'manchego', 'milk', 'romano', 'sour cream', 'yogurt', 'yoggies'].some(k => name.includes(k))) return 'Dairy & Eggs';
                if (['frozen', 'frzn', 'ice cream', 'nuggets', 'pizza', 'popsicle', 'pot-stickers', 'ravioli', 'waffles', 'wontons'].some(k => name.includes(k))) return 'Frozen Foods';
                if (['bars', 'cheez-its', 'chips', 'chomps', 'cookies', 'crackers', 'fig bar', 'goldfish', 'granola', 'jerky', 'nuts', 'popcorn', 'pretzels', 'seeds', 'snack'].some(k => name.includes(k))) return 'Snacks';
                if (['bullion', 'brownie mix', 'cereal', 'chia', 'chocolate chips', 'cholula', 'cinnamon', 'coffee', 'curry', 'dressing', 'flour', 'honey', 'jelly', 'ketchup', 'mac & cheese', 'maple syrup', 'marinara', 'matcha', 'mayonnaise', 'mustard', 'nut butter', 'nutella', 'oats', 'olive oil', 'pancake mix', 'paprika', 'pasta', 'peanut butter', 'pesto', 'pickles', 'ramen', 'rice', 'salt', 'sauce', 'seasoning', 'soy sauce', 'stock', 'sugar', 'taco seasoning', 'tomato sauce'].some(k => name.includes(k))) return 'Pantry';
                if (['baby wipes', 'cleaner', 'detergent', 'diapers', 'dish soap', 'dishwasher', 'floss', 'flonase', 'hand soap', 'laundry', 'paper towels', 'plates', 'pull-ups', 'soap', 'stain remover', 'tissue', 'toilet paper', 'toothpaste', 'trash bags', 'ziploc'].some(k => name.includes(k))) return 'Household & Baby';
                if (['body armor', 'celsius', 'coconut water', 'juice', 'spindrift', 'waterloo'].some(k => name.includes(k))) return 'Drinks';
                return 'Miscellaneous';
            };

            const switchTab = (tabName) => {
                document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active'));
                document.getElementById(`${tabName}-content`).classList.add('active');
                document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
                if (tabName === 'history') renderHistory();
            };

            const renderPriceChart = (itemName) => {
                if (priceChart) {
                    priceChart.destroy();
                }
                const history = [...(priceHistory[itemName] || [])].reverse();
                if (history.length < 2) {
                    chartContainer.classList.add('hidden');
                    return;
                }
                
                const labels = history.map(entry => entry.date);
                const data = history.map(entry => entry.price);

                chartContainer.classList.remove('hidden');
                const ctx = priceChartCanvas.getContext('2d');
                priceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Price of ${itemName}`,
                            data: data,
                            borderColor: '#005f9e',
                            backgroundColor: 'rgba(0, 95, 158, 0.1)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            };
            
            const renderHistory = () => {
                const selectedItemName = historyListEl.querySelector('.history-item.selected')?.dataset.itemName;
                historyListEl.innerHTML = '';
                const historyItems = Object.keys(priceHistory);

                if (historyItems.length === 0) {
                    historyListEl.innerHTML = `<li class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                        <h3>No Price History Yet</h3>
                        <p>When you add items with prices, their history will appear here.</p>
                    </li>`;
                    return;
                }
                
                historyItems.sort().forEach(itemName => {
                    const latestEntry = priceHistory[itemName][0];
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    if (itemName === selectedItemName) {
                        li.classList.add('selected');
                    }
                    li.dataset.itemName = itemName;
                    li.innerHTML = `<div class="history-item-main">
                                        <div class="history-item-name">${itemName}</div>
                                        <div class="history-item-details">Latest: 
                                            <span class="history-price" data-date="${latestEntry.date}">$${latestEntry.price.toFixed(2)}</span> on ${latestEntry.date}
                                        </div>
                                    </div>
                                    <div class="history-item-actions">
                                        <button class="history-action-btn rename-btn" title="Rename Item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg></button>
                                        <button class="history-action-btn update-price-btn" title="Update Latest Price"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.586l-1.22-1.22a.75.75 0 00-1.06 1.06l2.5 2.5a.75.75 0 001.06 0l2.5-2.5a.75.75 0 10-1.06-1.06l-1.22 1.22V2.75z" /><path d="M3 13.25a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.25 18.5h11.5A2.75 2.75 0 0018.5 15.75v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.25c-.69 0-1.25-.56-1.25-1.25v-2.5z" /></svg></button>
                                    </div>`;
                    historyListEl.appendChild(li);
                });

                if (selectedItemName) {
                    const selectedLi = historyListEl.querySelector(`[data-item-name="${selectedItemName}"]`);
                    if (selectedLi) {
                        const chartWrapper = document.getElementById('chart-wrapper-li') || document.createElement('li');
                        chartWrapper.id = 'chart-wrapper-li';
                        chartWrapper.appendChild(chartContainer);
                        selectedLi.after(chartWrapper);
                    }
                }
            };

            const renderList = () => {
                shoppingListEl.innerHTML = '';
                let runningTotal = 0;
                let lastCategory = null;

                if (shoppingList.length === 0) {
                    shoppingListEl.innerHTML = `<li class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5v-1.875a3.375 3.375 0 013.375-3.375h9.75a3.375 3.375 0 013.375 3.375v1.875m-17.25 4.5h16.5M6 12V6a3 3 0 013-3h3a3 3 0 013 3v6m-1.5-1.5h-5.25m5.25 0l-1.5-1.5m1.5 1.5l-1.5 1.5" /></svg>
                        <h3>Your List is Empty</h3>
                        <p>Use the form above to add items to your shopping list.</p>
                    </li>`;
                    totalCostEl.textContent = 'Total: $0.00';
                    return;
                }

                const sortedList = [...shoppingList].sort((a, b) => {
                    if (currentSort === 'alpha') return a.name.localeCompare(b.name);
                    if (currentSort === 'category') {
                        const catA = getCategory(a.name);
                        const catB = getCategory(b.name);
                        return catA === catB ? a.name.localeCompare(b.name) : catA.localeCompare(catB);
                    }
                    return a.dateAdded - b.dateAdded;
                });

                sortedList.forEach((item) => {
                    runningTotal += (parseFloat(item.price) || 0) * (parseInt(item.quantity, 10) || 1);

                    if (currentSort === 'category' && getCategory(item.name) !== lastCategory) {
                        lastCategory = getCategory(item.name);
                        const header = document.createElement('li');
                        header.className = 'category-header';
                        header.textContent = lastCategory;
                        shoppingListEl.appendChild(header);
                    }

                    const li = document.createElement('li');
                    li.className = 'list-item';
                    if (item.checked) li.classList.add('checked');

                    const textContainer = document.createElement('div');
                    textContainer.className = 'item-text-container';
                    textContainer.addEventListener('click', () => updateItem(item.id, { checked: !item.checked }));
                    
                    textContainer.innerHTML = `<span class="item-name">${item.name}</span> <span class="item-quantity">(x${item.quantity})</span>`;
                    li.appendChild(textContainer);

                    const priceContainer = document.createElement('div');
                    priceContainer.className = 'price-container';
                    const priceSpan = document.createElement('span');
                    priceSpan.className = 'item-price';
                    priceSpan.textContent = `$${item.price.toFixed(2)}`;
                    priceContainer.appendChild(priceSpan);
                    li.appendChild(priceContainer);

                    priceSpan.addEventListener('click', () => {
                        const priceInputEl = document.createElement('input');
                        priceInputEl.type = 'number';
                        priceInputEl.className = 'item-price-input';
                        priceInputEl.value = item.price.toFixed(2);
                        priceInputEl.step = '0.01';
                        priceContainer.replaceChild(priceInputEl, priceSpan);
                        priceInputEl.focus();
                        priceInputEl.select();
                        
                        const savePrice = () => {
                            const newPrice = parseFloat(priceInputEl.value) || 0;
                            updateItem(item.id, { price: newPrice });
                            updatePriceHistory(item.name, newPrice);
                        };
                        priceInputEl.addEventListener('blur', savePrice);
                        priceInputEl.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') priceInputEl.blur();
                        });
                    });
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193v-.443A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg>`;
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        deleteItem(item.id);
                    });
                    
                    li.appendChild(deleteBtn);
                    shoppingListEl.appendChild(li);
                });

                totalCostEl.textContent = `Total: $${runningTotal.toFixed(2)}`;
            };
            
            // --- Event Listeners ---
            addBtn.addEventListener('click', addItem);
            [priceInput, quantityInput].forEach(input => {
                input.addEventListener('keypress', (e) => { if (e.key === 'Enter') addItem(); });
            });
            itemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addItem(); });
            
            itemInput.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase();
                suggestionsContainer.innerHTML = '';
                if (!value) return;

                const filteredItems = Object.keys(priceHistory)
                    .filter(item => item.toLowerCase().includes(value))
                    .slice(0, 5);

                filteredItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = item;
                    div.addEventListener('click', () => {
                        itemInput.value = item;
                        if (priceHistory[item]) {
                            const latestEntry = priceHistory[item][0];
                            if (latestEntry && typeof latestEntry.price === 'number') {
                                priceInput.value = latestEntry.price.toFixed(2);
                            }
                        }
                        suggestionsContainer.innerHTML = '';
                    });
                    suggestionsContainer.appendChild(div);
                });
            });

            document.addEventListener('click', (e) => {
                if (e.target !== itemInput) {
                    suggestionsContainer.innerHTML = '';
                }
            });
            
            tabNav.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) switchTab(e.target.dataset.tab);
            });
            sortBar.addEventListener('click', (e) => {
                if (e.target.matches('.sort-btn')) {
                    currentSort = e.target.dataset.sort;
                    sortBar.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderList();
                }
            });

            clearListBtn.addEventListener('click', () => {
                confirmationModal.classList.remove('hidden');
            });
            cancelClearBtn.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
            });
            confirmClearBtn.addEventListener('click', clearList);

            historyListEl.addEventListener('click', (e) => {
                const itemEl = e.target.closest('.history-item');
                const renameBtn = e.target.closest('.rename-btn');
                const updatePriceBtn = e.target.closest('.update-price-btn');

                if (renameBtn) {
                    e.stopPropagation();
                    itemToRename = itemEl.dataset.itemName;
                    renameOldNameEl.textContent = itemToRename;
                    renameNewNameInput.value = itemToRename;
                    renameModal.classList.remove('hidden');
                    renameNewNameInput.focus();
                    return;
                }

                if (updatePriceBtn) {
                    e.stopPropagation();
                    const priceSpan = itemEl.querySelector('.history-price');
                    if(priceSpan) {
                        const currentPrice = parseFloat(priceSpan.textContent.replace('$', ''));
                        const priceInputEl = document.createElement('input');
                        priceInputEl.type = 'number';
                        priceInputEl.className = 'history-price-input';
                        priceInputEl.value = currentPrice.toFixed(2);
                        priceInputEl.step = '0.01';
                        priceSpan.replaceWith(priceInputEl);
                        priceInputEl.focus();
                        priceInputEl.select();

                        const saveHistoryPrice = () => {
                            const newPrice = parseFloat(priceInputEl.value) || 0;
                            updatePriceHistory(itemEl.dataset.itemName, newPrice);
                        };
                        priceInputEl.addEventListener('blur', saveHistoryPrice);
                        priceInputEl.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') priceInputEl.blur();
                        });
                    }
                    return;
                }
                
                if (itemEl) {
                    const wasSelected = itemEl.classList.contains('selected');
                    const existingChartWrapper = document.getElementById('chart-wrapper-li');
                    if (existingChartWrapper) existingChartWrapper.remove();
                    historyListEl.querySelectorAll('.history-item').forEach(el => el.classList.remove('selected'));
                    chartContainer.classList.add('hidden');

                    if (!wasSelected) {
                        itemEl.classList.add('selected');
                        const chartWrapper = document.createElement('li');
                        chartWrapper.id = 'chart-wrapper-li';
                        chartWrapper.appendChild(chartContainer);
                        itemEl.after(chartWrapper);
                        renderPriceChart(itemEl.dataset.itemName);
                    }
                }
            });

            cancelRenameBtn.addEventListener('click', () => {
                renameModal.classList.add('hidden');
                itemToRename = null;
            });
            confirmRenameBtn.addEventListener('click', () => {
                const newName = toTitleCase(renameNewNameInput.value.trim());
                if (itemToRename && newName) {
                    renameItemInDb(itemToRename, newName);
                }
                renameModal.classList.add('hidden');
                itemToRename = null;
            });
            
            locationSelect.addEventListener('change', (e) => {
                setCurrentLocation(e.target.value);
            });
            
            addLocationBtn.addEventListener('click', () => {
                addLocationModal.classList.remove('hidden');
                newLocationNameInput.focus();
            });
            cancelAddLocationBtn.addEventListener('click', () => {
                addLocationModal.classList.add('hidden');
            });
            confirmAddLocationBtn.addEventListener('click', async () => {
                const newLocation = toTitleCase(newLocationNameInput.value.trim());
                if (newLocation) {
                    await setDoc(doc(db, 'locations', newLocation), { created: Date.now() });
                    const sourceLocation = "Tukwila WA";
                    const sourceHistoryRef = collection(db, 'locations', sourceLocation, 'priceHistory');
                    const sourceHistorySnapshot = await getDocs(sourceHistoryRef);
                    const batch = writeBatch(db);
                    sourceHistorySnapshot.forEach(docSnapshot => {
                        const newDocRef = doc(db, 'locations', newLocation, 'priceHistory', docSnapshot.id);
                        batch.set(newDocRef, docSnapshot.data());
                    });
                    await batch.commit();
                    
                    newLocationNameInput.value = '';
                    addLocationModal.classList.add('hidden');
                }
            });
        });
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #005f9e; text-align: center; margin-top: 0; }
        .location-bar { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .location-bar label { font-weight: bold; color: #333; }
        #location-select { flex-grow: 1; padding: 8px; border-radius: 4px; border: 1px solid #ddd; font-size: 1em; }
        #add-location-btn { padding: 8px 12px; font-size: 1.2em; }
        .tab-nav { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab-btn { flex-grow: 1; padding: 10px 15px; border: none; background-color: transparent; cursor: pointer; font-size: 1.1em; color: #666; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; }
        .tab-btn.active { color: #005f9e; border-bottom-color: #005f9e; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .input-wrapper { position: relative; }
        .input-area { display: grid; grid-template-columns: 1fr auto auto auto; gap: 10px; margin-bottom: 20px; align-items: center; }
        #item-input, #price-input, #quantity-input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; }
        #item-input { width: 100%; box-sizing: border-box; }
        #price-input { width: 80px; }
        #quantity-input { width: 60px; }
        #add-btn { padding: 10px 15px; border: none; background-color: #e53238; color: white; border-radius: 4px; cursor: pointer; font-weight: bold; height: 100%; }
        #suggestions-container { position: absolute; background-color: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; width: 100%; box-sizing: border-box; z-index: 10; }
        #suggestions-container:empty { border: none; }
        .suggestion-item { padding: 10px; cursor: pointer; }
        .suggestion-item:hover { background-color: #f0f0f0; }
        .sort-bar { display: flex; gap: 10px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; align-items: center; }
        .sort-btn { padding: 8px 12px; border: 1px solid #ddd; background-color: #f8f9fa; border-radius: 4px; cursor: pointer; }
        .sort-btn.active { background-color: #005f9e; color: white; border-color: #005f9e; }
        #clear-list-btn { margin-left: auto; background-color: #6c757d; color: white; }
        #shopping-list, #history-list { list-style: none; padding: 0; margin: 0; }
        .category-header { font-weight: bold; color: #005f9e; background-color: #f4f4f9; padding: 8px 10px; margin-top: 10px; border-radius: 4px; }
        .list-item { display: flex; align-items: center; padding: 12px 10px; border-bottom: 1px solid #eee; font-size: 1.1em; }
        .item-text-container { cursor: pointer; flex-grow: 1; }
        .item-name { font-weight: 600; }
        .item-quantity { color: #666; font-size: 0.9em; margin-left: 4px; }
        .list-item.checked .item-name, .list-item.checked .item-quantity { text-decoration: line-through; color: #aaa; }
        .price-container { margin-left: auto; text-align: right; }
        .item-price { cursor: pointer; padding: 5px; border-radius: 4px; transition: background-color 0.2s; }
        .item-price:hover { background-color: #f0f0f0; }
        .item-price-input { width: 80px; font-size: 1em; text-align: right; border: 1px solid #005f9e; background-color: #f8f9fa; border-radius: 4px; padding: 5px; }
        .delete-btn { background: none; border: none; color: #aaa; cursor: pointer; padding: 5px; margin-left: 8px; }
        .delete-btn svg { width: 20px; height: 20px; }
        .delete-btn:hover { color: #e53238; }
        #total-cost { text-align: right; font-size: 1.4em; font-weight: bold; margin-top: 20px; color: #005f9e; }
        .history-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s; border-radius: 4px; display: flex; align-items: center; }
        .history-item-main { flex-grow: 1; }
        .history-item:hover, .history-item.selected { background-color: #eef7ff; }
        .history-item-name { font-weight: bold; font-size: 1.1em; }
        .history-item-details { font-size: 0.9em; color: #666; }
        .history-price { font-weight: bold; }
        .history-price-input { width: 60px; font-size: 0.9em; }
        .history-item-actions { display: flex; gap: 8px; }
        .history-action-btn { background: none; border: 1px solid #ddd; border-radius: 50%; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; }
        .history-action-btn:hover { background-color: #e9ecef; }
        .history-action-btn svg { width: 16px; height: 16px; color: #555; }
        #loading { text-align: center; padding: 40px; font-size: 1.2em; color: #666; }
        .empty-state { text-align: center; padding: 40px 20px; color: #888; }
        .empty-state svg { width: 48px; height: 48px; margin-bottom: 10px; color: #ccc; }
        .empty-state h3 { margin: 0 0 5px 0; color: #666; }
        .empty-state p { margin: 0; font-size: 0.9em; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 20; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; text-align: center; max-width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .modal-content input { width: 100%; padding: 10px; margin-top: 10px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ddd; }
        .modal-buttons { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        #confirm-clear-btn, #confirm-rename-btn, #confirm-add-location-btn { background-color: #e53238; color: white; }
        #cancel-clear-btn, #cancel-rename-btn, #cancel-add-location-btn { background-color: #6c757d; color: white; }
        .hidden { display: none; }
        #chart-container { margin-top: 10px; padding: 10px; background-color: #fafafa; border-radius: 4px; }
        #chart-wrapper-li { list-style-type: none; padding: 0 10px 10px 10px; }

        @media (max-width: 500px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            h1 { font-size: 1.5em; }
            .input-area { grid-template-columns: 1fr; gap: 10px; }
            #price-input, #quantity-input { width: 100%; box-sizing: border-box; }
            .sort-bar { flex-wrap: wrap; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🛒 Costco List</h1>
        <div id="loading">Connecting to your list...</div>
        
        <div id="app-content" style="display: none;">
            <div class="location-bar">
                <label for="location-select">Select Your Warehouse:</label>
                <select id="location-select"></select>
                <button id="add-location-btn" class="sort-btn">+</button>
            </div>

            <div class="tab-nav">
                <button class="tab-btn active" data-tab="list">Shopping List</button>
                <button class="tab-btn" data-tab="history">Price History</button>
            </div>
            <div id="list-content" class="tab-content active">
                <div class="input-area">
                    <div class="input-wrapper">
                        <input type="text" id="item-input" placeholder="e.g., Rotisserie Chicken" autocomplete="off">
                        <div id="suggestions-container"></div>
                    </div>
                    <input type="number" id="quantity-input" value="1" min="1" placeholder="Qty">
                    <input type="number" id="price-input" placeholder="Price" min="0" step="0.01">
                    <button id="add-btn">Add</button>
                </div>
                <div class="sort-bar">
                    <span>Sort by:</span>
                    <button class="sort-btn active" data-sort="added">Added</button>
                    <button class="sort-btn" data-sort="alpha">A-Z</button>
                    <button class="sort-btn" data-sort="category">Category</button>
                    <button class="sort-btn" id="clear-list-btn">Clear List</button>
                </div>
                <ul id="shopping-list"></ul>
                <div id="total-cost">Total: $0.00</div>
            </div>
            <div id="history-content" class="tab-content">
                <ul id="history-list"></ul>
            </div>
        </div>
    </div>

    <div id="chart-container" class="hidden">
        <canvas id="price-chart"></canvas>
    </div>

    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Are you sure?</h3>
            <p>This will permanently delete all items from the shopping list.</p>
            <div class="modal-buttons">
                <button id="cancel-clear-btn" class="modal-btn">Cancel</button>
                <button id="confirm-clear-btn" class="modal-btn">Clear List</button>
            </div>
        </div>
    </div>

    <div id="rename-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Rename Item</h3>
            <p>Enter the new name for "<strong id="rename-old-name"></strong>".</p>
            <input type="text" id="rename-new-name-input" placeholder="New item name">
            <div class="modal-buttons">
                <button id="cancel-rename-btn" class="modal-btn">Cancel</button>
                <button id="confirm-rename-btn" class="modal-btn">Save</button>
            </div>
        </div>
    </div>

    <div id="add-location-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Add New Location</h3>
            <p>Enter the name for the new shopping list (e.g., "City, ST").</p>
            <input type="text" id="new-location-name-input" placeholder="Location Name">
            <div class="modal-buttons">
                <button id="cancel-add-location-btn" class="modal-btn">Cancel</button>
                <button id="confirm-add-location-btn" class="modal-btn">Add</button>
            </div>
        </div>
    </div>
</body>
</html>
